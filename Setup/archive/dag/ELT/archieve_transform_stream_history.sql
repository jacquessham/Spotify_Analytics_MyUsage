insert into ctr__data.ctr__streaming_history(
	row_id,
	ts_timestamp,
	ts_epoch,
	ts_date,
	username,
	platform,
	ms_played,
	conn_country,
	ip_addr_decrypted,
	user_agent_decrypted,
	master_metadata_track_name,
	master_metadata_album_artist_name,
	master_metadata_album_album_name,
	spotify_track_uri,
	episode_name,
	episode_show_name,
	spotify_episode_uri,
	reason_start,
	reason_end,
	shuffle,
	skipped,
	offline,
	offline_timestamp,
	incognito_mode
) select 
concat(username, date_part('epoch',date_trunc('minute',ts::timestamp))::varchar,master_metadata_track_name),
date_trunc('minute',ts::timestamp),
date_part('epoch', date_trunc('minute',ts::timestamp)),
ts::date,
username,
platform,
ms_played::int,
conn_country,
ip_addr_decrypted,
user_agent_decrypted,
master_metadata_track_name,
master_metadata_album_artist_name,
master_metadata_album_album_name,
spotify_track_uri,
episode_name,
episode_show_name,
spotify_episode_uri,
reason_start,
reason_end,
shuffle::boolean,
skipped::boolean,
offline::boolean,
to_timestamp(offline_timestamp::numeric),
incognito_mode::boolean
from stg__data.stg__streaming_history__unique
where concat(username, date_part('epoch',date_trunc('minute',ts::timestamp))::varchar,master_metadata_track_name) not in (
	select row_id from ctr__data.ctr__streaming_history
)
;